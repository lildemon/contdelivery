<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>配置</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="css/bootstrap-tagsinput.css">
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-tagsinput.min.js"></script>
	<script src="js/utils.js"></script>
	<style>
		.bootstrap-tagsinput { margin-bottom: 0; }
	</style>
</head>
<body>
	<div class="container">
		 <div class="container">
		
		<table class="table table-bordered">
			<caption><h2>打包配置</h2></caption>
		  <thead>
		  	<tr>
		  		<th>类别</th><th>设置属性</th>
		  	</tr>
		  </thead>
		  <tbody>
		  	<tr>
		  		<td>开启自动min</td>
		  		<td>
		  			<div id="min">
		  				<input type="checkbox"> 
		  				<p class="text-right">
							<button type="button" class="btn btn-success btnSave">保存</button>
						</p>
		  			</div>
		  		</td>
		  	</tr>
		  	<tr>
		  		<td>开启自动合并</td>
		  		<td>
		  			<div id="autoCombine">
		  				<input type="checkbox"> 
		  				<p class="text-right">
							<button type="button" class="btn btn-success btnSave">保存</button>
						</p>
		  			</div>
		  		</td>
		  	</tr>
		  	<tr>
		  		<td>开启自动Reflow</td>
		  		<td>
		  			<div id="autoReflow">
		  				<input type="checkbox"> 
		  				<p class="text-right">
							<button type="button" class="btn btn-success btnSave">保存</button>
						</p>
		  			</div>
		  		</td>
		  	</tr>

		  	<!-- <tr>
		  		<td>Domain</td>
		  		<td>
		  			
		  			
		  						<p class="text-right">
		  							<button type="button" class="btn btn-primary">新建Entry</button>
		  							<button type="button" class="btn btn-success">保存</button>
		  						</p>
		  		</td>
		  	</tr>
		  	
		  	<tr>
		  		<td>图片Domain</td>
		  		<td></td>
		  	</tr> -->
		  </tbody>
		</table>

	</div>

		<table class="table table-bordered">
			<caption><h2>webpack配置</h2></caption>
		  <thead>
		  	<tr>
		  		<th>类别</th><th>设置属性</th>
		  	</tr>
		  </thead>
		  <tbody>
		  	<tr>
		  		<td>Pack目录名</td>
		  		<td>
		  			<form class="form-horizontal" id="packNameConfig">
		  				<div class="form-group">
						    <div class="col-md-10 form-inline">
						      <div class="input-group">
						      	<input class="form-control" type="text" value="packed" placeholder="Entry Name" name="packDirName">
						      </div>
							    <p class="text-right">
									<button type="button" class="btn btn-success savePackDirBtn">保存</button>
								</p>
						    </div>
					  	</div>
		  			</form>
		  			
		  		</td>
		  	</tr>

		  	<tr>
		  		<td>Entry</td>
		  		<td>
		  			
		  			<form class="form-horizontal" role="form" id="entryConfig">
						
						<script type="text/template" id="entry_row">
							<div class="form-group">
							    <label class="col-md-2 control-label"><button type="button" class="btn btn-danger btn-xs removeEntryBtn">X</button>&nbsp; Entry:</label>
							    <div class="col-md-10 form-inline">
							      <div class="input-group">
							      	<input class="form-control" type="text" value="<%=name%>" placeholder="Entry Name" name="entryName">
							      	<input class="form-control tags" type="text" value="<%=entrystr%>" placeholder="Contains File.." name="entryFiles">
							      </div>
							      	<p>
							      		As Common：<input class="commonCheck" type="checkbox" <%=isCommon ? 'checked' : ''%>>
							      	</p>
							    </div>

						  	</div>
						</script>
		  				<div class="rows">
		  				
		  				</div>
					  
					  
					  	<p class="text-right">
							<button type="button" class="btn btn-primary newEntryBtn">新建Entry</button>
							<button type="button" class="btn btn-success saveEntryBtn">保存</button>
						</p>
					</form>
					
		  		</td>
		  	</tr>

		  	<tr>
		  		<td>Alias配置</td>
		  		<td>
		  			<div class="form-group">
					    <label class="col-md-2 control-label"><button type="button" class="btn btn-danger btn-xs removeAliasBtn">X</button>&nbsp; Alias:</label>
					    <div class="col-md-10 form-inline">
					      <div class="input-group">
					      	<input class="form-control" type="text" value="<%=name%>" placeholder="Entry Name" name="aliasName">
					      	<input class="form-control tags" type="text" value="<%=entrystr%>" placeholder="Contains File.." name="aliasVal">
					      </div>
					    </div>

				  	</div>
		  		</td>
		  	</tr>

		  	<tr>
		  		<td>自定义Loader</td>
		  		<td></td>
		  	</tr>

		  	
		  </tbody>
		</table>

		<p class="text-center">
			<button type="button" class="btn btn-success">保存webpack配置</button>
		</p>

	</div>

	

	<script>
		var _ = require('lodash')
		//global.console = console
		var saveOperations = {
			saveEntry: function(callback) {
				project.projectConfig.webpack.entry = {}
				project.projectConfig.webpack.common = ''
				var $comp = $('#entryConfig')
				var entry = {}
				$comp.find('.form-group').each(function() {
					var $this = $(this)
					var name = $this.find('input[name="entryName"]').val()
					name = $.trim(name)
					if(name) {
						entry[name] = $this.find('input[name="entryFiles"]').tagsinput('items')
					}
				})
				project.projectConfig.webpack.entry = entry

				var $commonChecked = $comp.find('.commonCheck:checked').eq(0)
				if($commonChecked.length) {
					var commonName = $commonChecked.closest('.form-group').find('[name="entryName"]').val()
					if(commonName) {
						project.projectConfig.webpack.common = commonName
					}
					
				} 

				project.saveProjConfig(callback)
			},
			savePackDir: function(callback) {
				var $comp = $('#packNameConfig')
				var dirName = $comp.find('[name="packDirName"]').val()
				if(!dirName) {
					alert('请输入dir名字')
					return
				}
				project.projectConfig.webpack.packDirName = dirName
				project.saveProjConfig(callback)
			},
			saveAutoCombine: function(callback) {
				if(!project.projectConfig.fispack) {
					project.projectConfig.fispack = {}
				}
				_.extend(project.projectConfig.fispack, {
					autoCombine: $('#autoCombine input[type="checkbox"]').prop('checked')
				})
				project.saveProjConfig(callback)
			},
			saveAutoReflow: function(callback) {
				if(!project.projectConfig.fispack) {
					project.projectConfig.fispack = {}
				}
				_.extend(project.projectConfig.fispack, {
					autoReflow: $('#autoReflow input[type="checkbox"]').prop('checked')
				})
				project.saveProjConfig(callback)
			},
			saveMin: function(callback) {
				if(!project.projectConfig.fispack) {
					project.projectConfig.fispack = {}
				}
				_.extend(project.projectConfig.fispack, {
					min: $('#min input[type="checkbox"]').prop('checked')
				})
				project.saveProjConfig(callback)
			}
		}

		var afterSaveOperations = {
			// get after save from save btn's parent
		}

		function parallelSave(arr, callback) {
			// parallel save operations, optionally calls callback after all done
			var count = arr.length
			var finishCount = 0
			var checkDone = function() {
				if(finishCount == count) {
					callback()
				}
			}
			arr.forEach(function(s) {
				saveOperations[s](function(err) {
					finishCount++
					checkDone()
				})
			})
		}
	</script>
	<script>
		var projectLib = require('./projectLib')
		var id = getURLParameter('id')
		var project = projectLib.getProjectById(id)


		void function() {
			if(!project) {
				alert('找不到该项目')
				return
			}

			project.updateMiddleware()
		}()

		//Fis Pack
		void function() {
			var $combComp = $('#autoCombine')
			var $reflowComp = $('#autoReflow')
			var $minComp = $('#min')

			project.getProjConfig(function(conf) {
				var fispack = conf.fispack
				if(fispack) {
					if(fispack.autoCombine) {
						$combComp.find('[type="checkbox"]').prop('checked', true)
					}
					if(fispack.autoReflow) {
						$reflowComp.find('[type="checkbox"]').prop('checked', true)
					}

					if(fispack.min) {
						$minComp.find('[type="checkbox"]').prop('checked', true)
					}
				}
				
			})

			$combComp.on('click', '.btnSave', function() {
				saveOperations['saveAutoCombine'](function() {
					alert('保存成功')
				})
			})

			$reflowComp.on('click', '.btnSave', function() {
				saveOperations['saveAutoReflow'](function() {
					alert('保存成功')
				})
			})
			$minComp.on('click', '.btnSave', function() {
				saveOperations['saveMin'](function() {
					alert('保存成功')
				})
			})
		}()

		//Pack Dir Name
		void function() {
			var $comp = $('#packNameConfig')
			project.getProjConfig(function(conf) {
				var wpconf = conf.webpack
				if(wpconf.packDirName) {
					$comp.find('[name="packDirName"]').val(wpconf.packDirName)
				}
			})

			$comp.on('click', '.savePackDirBtn', function() {
				saveOperations['savePackDir'](function() {
					alert('保存成功')
				})
				project.updateMiddleware()
			})
		}()

		//Entrys
		void function() {
			var $comp = $('#entryConfig')
			var $rows = $comp.find('.rows')

			$comp.find('.newEntryBtn').click(function() {
				newRow()
			})
			$comp.on('click', '.removeEntryBtn', function() {
				$(this).closest('.form-group').remove()
			})
			.on('click', '.saveEntryBtn', function() {
				saveOperations['saveEntry'](function() {
					alert('保存成功')
				})
				project.updateMiddleware()
			})
			.on('change', '.commonCheck', function() {
				var $this = $(this)
				if($this.prop('checked')) {
					$comp.find('.commonCheck').not($this).prop('checked', false)
				}
			})

			project.getProjConfig(function(conf) {
				var wpconf = conf.webpack
				var name, files, isCommon = false
				if(wpconf.entry) {
					for(name in wpconf.entry) {
						isCommon = (wpconf.common && wpconf.common == name)
						files = wpconf.entry[name]
						newRow(name, files, isCommon)
					}
				}

			})

			function newRow(name, entries, isCommon) {
				$row = $($.parseHTML(tmpl('entry_row', {
					name: name,
					entrystr: $.isArray(entries) ? entries.join(',') : '',
					isCommon: isCommon
				})))
				$rows.append($row)
				$row.find('input.tags').tagsinput()
			}

		}()


	</script>
</body>
</html>