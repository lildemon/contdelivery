<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>TMUED</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">
	<script src="js/jquery-1.7.2.min.js"></script>
	<script src="js/utils.js"></script>
</head>
<body>
	<h3>已装载的项目</h3>
	<div id="loaded">
		
	</div>

	<div id="chooser">
		<h3>添加一个项目目录</h2>
		<input type="file" id="projpath" nwdirectory /> <button id="addProjectBtn">确定</button>
	</div>

	
	<div>
		<h3>装载最近的项目</h3>
		<div id="recent">
			
		</div>
	</div>

	<script type="text/template" id="recentItem">
		<li data-path="<%=path%>">
			<span><%=path%></span> &nbsp;&nbsp;&nbsp; <button data-path="<%=path%>">装载</button>
		</li>
	</script>

	<script type="text/template" id="loadedItem">
		<li data-path="<%=path%>">
			<span><%=path%></span> &nbsp;&nbsp;&nbsp; <button data-id="<%=id%>" class="open">打开</button> &nbsp;&nbsp; <button data-path="<%=path%>" class="pack">打包</button> &nbsp;&nbsp; <button data-path="<%=path%>" class="dir">打开目录</button>
		</li>
	</script>

	<script>

		var projectLib = require('./projectLib')
		var gui = require('nw.gui')
		var child_process = require('child_process')
		var path = require('path')
		var loadedProjectMap = {}, LOADED = 1
		var listenPort = 8223

		projectLib.startServer(listenPort)

		

		$('#addProjectBtn').click(function() {
			var projPath = $('#projpath').val()
			if(projPath) {
				loadProject(projPath)
			}
		})

		$('#recent').on('click', 'button', function() {
			loadProject($(this).data('path'))
		})

		$('#loaded').on('click', '.open', function() {
			gui.Shell.openExternal('http://' + $(this).data('id') + '.local.tmued.com:' + listenPort)
		})
		.on('click', '.dir', function() {
			var projPath = $(this).data('path')
			gui.Shell.openExternal(projPath)
		})
		.on('click', '.pack', function() {
			var projPath = $(this).data('path')
			var confis = path.join(path.dirname(process.execPath), 'ContFis')
			var node = path.join(confis, 'node.exe')

			var job = child_process.spawn(node, [
				'index.js',
				'--root', path.join(projPath, 'wwwroot'), // use Project.wwwroot
				'--dest', path.join(projPath, 'output')
			], {
				cwd: confis
			})

			var out = '', err = ''
			job.stdout.on('data', function(data) {
				out += data
			})

			job.stderr.on('data', function(data) {
				err += data
			})

			job.on('close', function(code) {
				if(code != 0) {
					console.log('ERROR: \n' + err)
					alert('打包时发生错误： \n' + err + '\n\n')
				} else {
					alert('打包完成')
				}
				//console.log(out)
			})
		})

		function loadProject(projPath) {
			if(!projPath) {
				return
			}
			if(loadedProjectMap[projPath]) {
				alert('你已经装载了该项目')
				return
			}
			projectLib.loadProject(projPath)
			loadedProjectMap[projPath] = LOADED
			saveProjectPath(projPath)
			updateRecentPaths()
			updateLoadedProjects()
		}

		function updateLoadedProjects() {
			var loadedProjs = projectLib.getLoadedProject()
			var html = '<ul>'
			$.each(loadedProjs, function(i, p) {
				html += tmpl('loadedItem', p)
			})
			html += '</ul>'
			$('#loaded').html(html)
		}

		function updateRecentPaths() {
			var storedPaths = getProjectPaths()
			var html = '<ul>'
			storedPaths.forEach(function(path) {
				html += tmpl('recentItem', {path: path})
			})
			html += '</ul>'
			$('#recent').html(html)
		}

	</script>

	<script>
		updateRecentPaths()
	</script>
	


	
</body>
</html>