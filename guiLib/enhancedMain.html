<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<title>Start Point</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">

	<style>
		.panel-heading { padding: 5px 15px; }
		.panel-body { padding: 10px; }
			.panel-body ul { margin: 0; }
		.panel-footer { padding: 10px 15px; }
		.panel-footer p { margin: 0; }

		.col-sm-6 { padding-left: 10px; padding-right: 10px; }
		.pathTitle { display: inline-block; width: 80%; overflow: hidden; }
		.alert { margin-bottom: 0; margin-top: 10px; }
	</style>
</head>
<body>
	<div class="well well-sm">
		<div class="container-fluid">
			<h4>管理已装载项目</h4>
			<div class="row" id="loaded-container"></div>
			
		</div>
	</div>
	<div class="well well-sm">
		<div class="container-fluid">
			<h4>载入新项目</h4>
			<div class="row">
				<div class="col-sm-6 col-md-4" id="load-from-history">
					<div class="panel panel-info">
						<div class="panel-heading"><span class="glyphicon glyphicon-time"> </span> &nbsp;项目载入历史</div>
						<div class="panel-body" id="historyContainer"></div>
					</div>
				</div>
				<div class="col-sm-6 col-md-4" id="load-from-folder">
					<div class="panel panel-success">
						<div class="panel-heading"><span class="glyphicon glyphicon-folder-open"> </span> &nbsp;从文件夹装载项目</div>
						<div class="panel-body">
    						<div class="input-group">
    							<input type="file" class="form-control" id="projpath" nwdirectory>
    							<div class="input-group-btn">
            						<button type="button" class="btn btn-success" tabindex="-1" id="addProjectBtn">载入</button>
            					</div>
    						</div>

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/Remix.js"></script>
	<script src="js/utils.js"></script>
	<script src="js/enhancedMain.js"></script>
	<script>
		global.mainConsole = console

		var projectLib = require('./projectLib')
		var gui = require('nw.gui')
		var child_process = require('child_process')
		var path = require('path')
		var fs = require('fs')
		var loadedProjectMap = {}, LOADED = 1
		var listenPort = 8223

		projectLib.startServer(listenPort)

		$('#addProjectBtn').click(function() {
			var projPath = $('#projpath').val()
			if(projPath) {
				loadProject(projPath)
			}
		})

		function loadProject(projPath) {
			if(!projPath) {
				return
			}
			if(loadedProjectMap[projPath]) {
				alert('你已经装载了该项目')
				return
			}
			var project = projectLib.loadProject(projPath)
			loadedProjectMap[projPath] = LOADED
			saveProjectPath(projPath)
			updateRecentPaths()
			var loadInst = LoadedItem({
				path: projPath,
				urls: ['http://' + project.id + '.local.tmued.com:' + listenPort],
				unloadProject: function() {
					projectLib.unloadProject(project.id)
					delete loadedProjectMap[projPath]
					loadInst.slideDestroy()
				}
			}, project.id)
		}


		function updateRecentPaths() {
			reloadHistory()
		}

		function packProject(id, projPath, inst) {

			var project = projectLib.getProjectById(id)
			
			var confis = path.join(path.dirname(process.execPath), 'ContFis')
			var node = path.join(confis, 'node.exe')
			inst.msg('<strong>正在打包</strong>')

			project.getProjConfig(function(conf) {
				if(conf.webpack.entry) {
					project.compileWebpack(runPack)
				} else {
					runPack()
				}
				function runPack() {
					var jobArg = [
						'index.js',
						'--root', path.join(projPath, 'wwwroot'), // use Project.wwwroot
						'--dest', path.join(projPath, 'output')
					]

					var fisfile = path.join(projPath, 'fis-config.js')
					if(fs.existsSync(fisfile)) {
						jobArg.push('--fisfile')
						jobArg.push(fisfile)
					}
					if(conf.fispack && conf.fispack.autoCombine) {
						jobArg.push('--combine')
					}

					if(conf.fispack && conf.fispack.min) {
						jobArg.push('--min')
					}

					if(conf.fispack && conf.fispack.autoReflow) {
						jobArg.push('--reflow')
					}

					var job = child_process.spawn(node, jobArg, {
						cwd: confis
					})

					var out = '', err = ''
					job.stdout.on('data', function(data) {
						out += data
					})

					job.stderr.on('data', function(data) {
						err += data
					})

					job.on('close', function(code) {
						if(code != 0) {
							//console.log('ERROR: \n' + err)
							inst.msg('打包时发生错误： \n' + err + '\n\n')
							//$this.closest('li').find('.msg').text(err)
						} else {
							inst.closeMsg('打包完成')
							inst.openOutput()
						}
						//console.log(out)
					})
				}
			})
		}

	</script>
</body>
</html>